/*! threesixty 18-12-2014 */
!function(){for(var a=0,b=["ms","moz","webkit","o"],c=0;c<b.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b){var c=(new Date).getTime(),d=Math.max(0,16-(c-a)),e=window.setTimeout(function(){b(c+d)},d);return a=c+d,e}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)})}(),function(a,b){"use strict";var c=function(a){a=a||{};for(var b in this._defaults)a[b]=a[b]||this._defaults[b];var c=this;for(var d in this._defaults)typeof this._defaults[d]==typeof a[d]?c[d]=a[d]:console.warn("Threesixty: constructor option "+d+" must be of type "+typeof this._defaults[d]);this.$el||(this.$el=$(document.createElement("div")),this.$el.addClass("threesixty"),$("body").append(this.$el)),this.create(),this.layout()};c.prototype._defaults={$el:null,width:640,height:480,ready:0,renderMeta:{normal:{width:640,height:480}}},c.prototype.create=function(){this.$el.html(""),this._canvas=document.createElement("canvas"),this._$canvas=$(this._canvas),this._$canvas.addClass("threesixty-canvas"),this.$el.append(this._$canvas),this._context=this._canvas.getContext("2d"),this._$loader=$(document.createElement("div")),this._$loader.addClass("threesixty-loader-bar"),this._$loader.width("0px"),this._$loader.height("3px"),this._$loader.css("background","#ff5c5c"),this._$loader.css("position","absolute"),this._$loader.css("top","0px"),this._$loader.css("left","0px"),this.$el.append(this._$loader),window.addEventListener("touchmove",function(a){a.target.classList.contains("threesixty-canvas")&&a.preventDefault()},!1)},c.prototype.layout=function(){this.$el.width(this.width),this.$el.height(this.height),this._$canvas.width(this.width),this._$canvas.height(this.height),this.renderMeta.hasOwnProperty("HD")?(this.renderMeta.HD.hasOwnProperty("width")&&this._$canvas.attr("width",this.renderMeta.HD.width),this.renderMeta.HD.hasOwnProperty("height")&&this._$canvas.attr("height",this.renderMeta.HD.height)):(this._$canvas.attr("width",this.width),this._$canvas.attr("height",this.height)),this.$el.css("background",this.bgColor),this.$el.css("position","relative"),this.$el.css("overflow","hidden")},c.prototype.load=function(a){this.renderMeta={},a=a||{};var b={rows:1,loopX:!0,loopY:!1,loadAfterinit:!0,startOnStatus:1,startRow:-1,swoosh:!0,autoRotate:!1,rotationTime:5e3,bgColor:"#FFFFFF",normal:{sources:[],width:640,height:480},HD:{sources:[]}};for(var c in b)a[c]=a.hasOwnProperty(c)?a[c]:b[c];1==a.autoRotate&&(a.swoosh=!1);var d=this;for(var e in b)typeof b[e]==typeof a[e]?d.renderMeta[e]=a[e]:console.warn("Threesixty: load option "+e+" must be of type "+typeof b[e]);this.renderMeta.loadAfterinit&&this.show()},c.prototype.show=function(){function a(){var a=0,b=function(){j.loadRow({row:a,render:!1,onFrame:function(a){var b=(a.frame+f*a.row)/(f*e),c=b*j.width;j._$loader.width(c)},onComplete:function(){e-1>a?(j.hasOwnProperty("onRowLoaded")&&j.renderMeta.startRow!==a&&j.onRowLoaded({row:a}),a++,b()):(j.ready=2,j._$loader.width(0),2==j.renderMeta.startOnStatus&&j.renderer(),j.hasOwnProperty("onRowLoaded")&&j.onRowLoaded({row:a}),j.hasOwnProperty("onComplete")&&j.onComplete())}})};b()}this.frames=[],this.HDframes=[];var b=this.renderMeta.normal.sources,c=this.renderMeta.HD.sources,d=!1;c&&c.length>0&&b.length==c.length&&(d=!0);var e=this.renderMeta.rows,f=Math.floor(b.length/e);this.renderMeta.perRow=f;for(var g=0;g<this.renderMeta.rows;g++){this.frames.push([]),this.HDframes.push([]);for(var h=f-1;h>=0;h--)if(this.frames[g].push(null),d===!0){var i=c[f-h-1+f*g];this.HDframes[g].push(i)}}-1==this.renderMeta.startRow?this.renderMeta.startRow=Math.floor(e/2):this.renderMeta.startRow>=e&&(this.renderMeta.startRow=e-1);var j=this;this.loadRow({row:j.renderMeta.startRow,render:!0,onFrame:function(a){var b=a.frame/f,c=b*j.width;j._$loader.width(c)},onComplete:function(b){j._$loader.width(0),j.ready=1,e>1?(1==j.renderMeta.startOnStatus&&j.renderer(),j.hasOwnProperty("onFirstRowLoaded")&&j.onFirstRowLoaded({row:j.renderMeta.startRow}),j.hasOwnProperty("onRowLoaded")&&j.onRowLoaded({row:j.renderMeta.startRow}),a(b)):(j.renderer(),j.renderMeta.startRow==e-1&&(j.hasOwnProperty("onFirstRowLoaded")&&j.onFirstRowLoaded({row:j.renderMeta.startRow}),j.hasOwnProperty("onRowLoaded")&&j.onRowLoaded({row:j.renderMeta.startRow}),j.hasOwnProperty("onComplete")&&j.onComplete()))}})},c.prototype.loadRow=function(a){for(var c=this.renderMeta.normal.sources,d=this.renderMeta.rows,e=Math.floor(c.length/d),f=a.row*e,g=f+e-1,h=f,i=!1,j=e-1;j>=0;j--){var k=this.frames[a.row][j];null===k&&(i=!0)}var l=this;if(1==i){var m=l.renderMeta.normal,n=(l.renderMeta.HD,function(){var d=document.createElement("img");d.onload=function(){var c=a.row,d=h-e*c;if(null==l.frames[c][d]&&(l.frames[c][d]=this),h++,1==a.render&&(l._context.globalAlpha=1,l._context.clearRect(0,0,l.width,l.height),l._context.drawImage(this,0,0,m.width,m.height,0,0,l._canvas.width,l._canvas.height),g>=h&&(l._context.globalAlpha=.8,l._context.beginPath(),l._context.rect(0,0,l._canvas.width,l._canvas.height),l._context.fillStyle=l.renderMeta.bgColor,l._context.fill())),h>g){if(a.hasOwnProperty("onComplete")){var d=h-e*c-1;a.onComplete({row:a.row,frame:d})}h=b}else{if(a.hasOwnProperty("onFrame")){var d=h-e*c-1;a.onFrame({row:a.row,frame:d})}n()}},d.src=c[h]});n()}else l.renderMeta.startRow!==a.row&&console.warn("Threesixty: loader row "+a.row+" is already loaded."),a.hasOwnProperty("onComplete")&&a.onComplete({row:a.row,frame:e-1})},c.prototype.renderer=function(){var a=this,c=a.renderMeta,d=c.normal,e=c.HD;c.currentRow=c.startRow,c.currentFrame=0,c.currentZoom=0,c.interactions={enabled:!1,isDragging:!1,startFrame:null,startRow:null,dragPosition:null,targetFrame:null,targetRow:null,startZoom:0,zoom:1,initHD:!1},c.rotation={isPlaying:!1,frame:0},this.findFrame=function(b){if(b.row!==c.currentRow||b.frame!==c.currentFrame){c.currentRow=b.row,c.currentFrame=b.frame;var e=a.frames[b.row][b.frame],f=function(){a._context.clearRect(0,0,a._canvas.width,a._canvas.height),a._context.drawImage(e,0,0,d.width,d.height,0,0,a._canvas.width,a._canvas.height)};window.requestAnimationFrame?window.requestAnimationFrame(f):setTimeout(f,16)}},this.drawHDFrame=function(){var d=a.HDframes[c.currentRow][c.currentFrame];d!==b&&null!==d&&(a.lastHDimg=document.createElement("img"),a.lastHDimg.onload=function(){(e.width==b||0==e.width)&&(e.width=this.width),(e.height==b||0==e.height)&&(e.height=this.height),a._context.clearRect(0,0,a._canvas.width,a._canvas.height),a._context.drawImage(a.lastHDimg,0,0,e.width,e.height,0,0,a._canvas.width,a._canvas.height)},a.lastHDimg.src=d,0==c.interactions.initHD&&(c.interactions.initHD=!0))},this.swoosh=function(){c.rotation={frame:0,isPlaying:!1},$(c.rotation).animate({frame:c.perRow},{duration:1300,easing:"easeOutCubic",step:function(){a.findFrame({row:a.renderMeta.startRow,frame:Math.floor(this.frame)})},complete:function(){a.enableInteraction()}})},this.autoRotate=function(b){0==c.rotation.isPlaying&&(c.rotation.isPlaying=!0,c.rotation.frame=0,$(c.rotation).stop().animate({frame:c.perRow},{duration:c.rotationTime,easing:"linear",step:function(){c.rotation.isPlaying=!0,a.findFrame({row:a.renderMeta.startRow,frame:Math.floor(c.rotation.frame)})},complete:function(){c.rotation.isPlaying=!1,a.autoRotate()}}),a.enableInteraction(),b&&b())},this.stopAutoRotate=function(a){$(c.rotation).stop(),c.rotation.isPlaying=!1,a&&a()},this.animatedZoom=function(b){e.width/d.width;b.factor>1?b.factor=1:b.factor<=0&&(b.factor=0);var f=b.factor;b.duration||(b.duration=600),b.factor!==c.currentZoom&&$({factor:c.currentZoom}).animate({factor:f},{duration:b.duration,easing:"easeOutCubic",step:function(){a.applyZoom(this.factor)},complete:function(){b.callback&&b.callback()}})},this.applyZoom=function(b){var f=e.width/d.width,b=b;0==c.interactions.initHD&&a.drawHDFrame(),c.rotation.hasOwnProperty("isPlaying")&&1==c.rotation.isPlaying&&a.stopAutoRotate(),0>b?b=0:b>1&&(b=1),c.currentZoom=b,a._$canvas.css("transform","matrix("+(1+(f-1)*b)+", 0, 0, "+(1+(f-1)*b)+", 0, 0)")},this.enableInteraction=function(){function b(b){c.rotation.hasOwnProperty("isPlaying")&&1==c.rotation.isPlaying&&a.stopAutoRotate(),c.interactions.dragPosition=b,c.interactions.startFrame=c.currentFrame,c.interactions.startRow=c.currentRow,c.interactions.isDragging=!0,a.lastHDimg&&(a.lastHDimg.onload=null)}function d(b){var d=c.currentRow;if(2==a.ready&&a.frames.length>1){var e=-1*Math.round((b.y-c.interactions.dragPosition.y)/60);d=c.interactions.startRow+e;var f=d/a.frames.length;f=Math.floor(f>0?f:f),c.loopY?d+=-1*a.frames.length*f:0>f?d=0:f>0&&(d=a.frames.length-1)}var g=Math.round((b.x-c.interactions.dragPosition.x)/20),h=c.interactions.startFrame+g,i=h/c.perRow;i=Math.floor(i>0?i:i),c.loopX?h+=-1*c.perRow*i:0>i?h=0:i>0&&(h=c.perRow-1),a.findFrame({row:d,frame:h})}function e(){1==c.interactions.isDragging&&(c.interactions.isDragging=!1,a.drawHDFrame())}0==c.interactions.enabled&&(c.interactions.enabled=!0,a.$el.mousedown(function(a){b({x:a.pageX,y:a.pageY})}),$(window).mousemove(function(a){1==c.interactions.isDragging&&d({x:a.pageX,y:a.pageY})}),$(window).mouseup(e),a.$el.bind("touchstart",function(a){a.preventDefault(),b({x:a.originalEvent.touches[0].pageX,y:a.originalEvent.touches[0].pageY})}),a.$el.bind("touchmove",function(a){a.preventDefault();var b=a.originalEvent.touches;1==c.interactions.isDragging&&b.length<=1&&d({x:b[0].pageX,y:b[0].pageY})}),$(window).bind("touchend",function(a){a.preventDefault(),e(a)}),a.$el.bind("gesturestart",function(a){a.preventDefault(),c.interactions.startZoom=c.currentZoom}),a.$el.bind("gesturechange",function(b){b.preventDefault();var d=b.originalEvent.scale,e=0;d>1?e=c.interactions.startZoom+(d-1)/5*2:1>d&&(e=c.interactions.startZoom-1.7*(1-d)),e>=0&&1>=e&&a.applyZoom(e)}),a.$el.on("mousewheel",function(b){b.preventDefault();var d=b.originalEvent.deltaY,e=Math.abs(d)/d;e&&a.applyZoom(c.currentZoom+e/50)}))},a.findFrame({row:a.renderMeta.startRow,frame:0})},c.VERSION="0.1.0",a.Threesixty=c}(this);
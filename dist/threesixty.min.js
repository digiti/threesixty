/*! threesixty 28-03-2015 */
!function(){for(var a=0,b=["ms","moz","webkit","o"],c=0;c<b.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b){var c=(new Date).getTime(),d=Math.max(0,16-(c-a)),e=window.setTimeout(function(){b(c+d)},d);return a=c+d,e}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)})}(),function(a,b){"use strict";var c=function(a){a=a||{};for(var b in this._defaults)a[b]=a[b]||this._defaults[b];var c=this;for(var d in this._defaults)typeof this._defaults[d]==typeof a[d]?c[d]=a[d]:console.warn("Threesixty: constructor option "+d+" must be of type "+typeof this._defaults[d]);this.$el||(this.$el=$(document.createElement("div")),this.$el.addClass("threesixty"),$("body").append(this.$el)),this.create()};c.prototype._defaults={$el:null,width:640,height:480,bgColor:"#000000",ready:0,renderMeta:{}},c.prototype.create=function(){this.$el.html(""),this._canvas=document.createElement("canvas"),this._$canvas=$(this._canvas),this._$canvas.addClass("threesixty-canvas"),this.$el.append(this._$canvas),this._context=this._canvas.getContext("2d"),this._$loader=$(document.createElement("div")),this._$loader.addClass("threesixty-loader-bar"),this._$loader.width("0px"),this._$loader.height("3px"),this._$loader.css("background","#ff5c5c"),this._$loader.css("position","absolute"),this._$loader.css("top","0px"),this._$loader.css("left","0px"),this.$el.append(this._$loader),window.addEventListener("touchmove",function(a){a.target.classList.contains("threesixty-canvas")&&a.preventDefault()},!1)},c.prototype.layout=function(){this.$el.width(this.width),this.$el.height(this.height),this._$canvas.width(this.width),this._$canvas.height(this.height),this.renderMeta.hasOwnProperty("HD")&&this.renderMeta.HD.hasOwnProperty("width")&&this.renderMeta.HD.hasOwnProperty("height")?(this._$canvas.attr("width",this.renderMeta.HD.width),this._$canvas.attr("height",this.renderMeta.HD.height)):(this._$canvas.attr("width",this.width),this._$canvas.attr("height",this.height)),this.$el.css("background",this.bgColor),this.$el.css("position","relative"),this.$el.css("overflow","hidden")},c.prototype.load=function(a){this.renderMeta={},this.loadMeta={},a=a||{};var b={rows:1,loopX:!0,loopY:!1,loadAfterinit:!0,startOnStatus:1,startRow:-1,swoosh:!0,autoRotate:!1,rotationTime:5e3,invertX:!1,invertY:!1,extraZoom:0,showDefaultLoading:!0,normal:{sources:[],width:640,height:480},HD:{sources:[]}};for(var c in b)a[c]=a.hasOwnProperty(c)?a[c]:b[c];1==a.autoRotate&&(a.swoosh=!1),a.normal.width||(a.normal.width=b.normal.width),a.normal.height||(a.normal.height=b.normal.height);var d=this;for(var e in b)typeof b[e]==typeof a[e]?d.renderMeta[e]=a[e]:console.warn("Threesixty: load option "+e+" must be of type "+typeof b[e]);this.renderMeta.loadAfterinit&&(this.layout(),this.show())},c.prototype.show=function(){function a(){var a=0,b=function(){j.loadRow({row:a,render:!1,onFrame:function(a){var b=(a.frame+f*a.row)/(f*e);if(j.renderMeta.showDefaultLoading){var c=b*j.width;j._$loader.width(c)}},onComplete:function(){e-1>a?(j.hasOwnProperty("onRowLoaded")&&j.renderMeta.startRow!==a&&j.onRowLoaded({row:a}),a++,b()):(j.ready=2,j._$loader.width(0),2==j.renderMeta.startOnStatus&&j.renderer(),j.hasOwnProperty("onRowLoaded")&&j.onRowLoaded({row:a}),j.hasOwnProperty("onComplete")&&j.onComplete())}})};b()}this.frames=[],this.HDframes=[],this.loadMeta.total=0,this.loadMeta.current=0;var b=this.renderMeta.normal.sources,c=this.renderMeta.HD.sources,d=!1;c&&c.length>0&&b.length==c.length&&(d=!0);var e=this.renderMeta.rows,f=Math.floor(b.length/e);this.renderMeta.perRow=f;for(var g=0;g<this.renderMeta.rows;g++){this.frames.push([]),this.HDframes.push([]);for(var h=f-1;h>=0;h--)if(this.frames[g].push(null),this.loadMeta.total++,d===!0){var i=c[f-h-1+f*g];this.HDframes[g].push(i)}}-1==this.renderMeta.startRow?this.renderMeta.startRow=Math.floor(e/2):this.renderMeta.startRow>=e&&(this.renderMeta.startRow=e-1),console.log("loadTotal: "+this.loadMeta.total);var j=this;this.loadRow({row:j.renderMeta.startRow,render:!0,onFrame:function(a){if(j.renderMeta.showDefaultLoading){var b=a.frame/f,c=b*j.width;j._$loader.width(c)}},onComplete:function(b){j._$loader.width(0),j.ready=1,e>1?(1==j.renderMeta.startOnStatus&&j.renderer(),j.hasOwnProperty("onFirstRowLoaded")&&j.onFirstRowLoaded({row:j.renderMeta.startRow}),j.hasOwnProperty("onRowLoaded")&&j.onRowLoaded({row:j.renderMeta.startRow}),a(b)):(j.renderer(),j.renderMeta.startRow==e-1&&(j.hasOwnProperty("onFirstRowLoaded")&&j.onFirstRowLoaded({row:j.renderMeta.startRow}),j.hasOwnProperty("onRowLoaded")&&j.onRowLoaded({row:j.renderMeta.startRow}),j.hasOwnProperty("onComplete")&&j.onComplete()))}})},c.prototype.loadRow=function(a){for(var c=this.renderMeta.normal.sources,d=this.renderMeta.rows,e=Math.floor(c.length/d),f=a.row*e,g=f+e,h=f,i=!1,j=e-1;j>=0;j--){var k=this.frames[a.row][j];null===k&&(i=!0)}var l=this;if(1==i){var m=l.renderMeta.normal,n=(l.renderMeta.HD,function(){var d=document.createElement("img");if(d.onload=function(){var c=a.row,d=h-e*c;if(null==l.frames[c][d]&&(l.frames[c][d]=this),h++,1==a.render&&(l._context.globalAlpha=1,l._context.clearRect(0,0,l.width,l.height),l._context.drawImage(this,0,0,m.width,m.height,0,0,l._canvas.width,l._canvas.height),g>=h&&(l._context.globalAlpha=.8,l._context.beginPath(),l._context.rect(0,0,l._canvas.width,l._canvas.height),l._context.fillStyle=l.bgColor,l._context.fill())),l.loadMeta.current++,h>=g){if(l.hasOwnProperty("onFrameLoaded")&&l.onFrameLoaded({frame:l.loadMeta.current,total:l.loadMeta.total}),a.hasOwnProperty("onComplete")){var d=h-e*c-1;a.onComplete({row:a.row,frame:d})}h=b}else{if(a.hasOwnProperty("onFrame")){var d=h-e*c-1;a.onFrame({row:a.row,frame:d})}l.hasOwnProperty("onFrameLoaded")&&l.onFrameLoaded({frame:l.loadMeta.current,total:l.loadMeta.total}),n()}},h!==b)d.src=c[h];else if(a.hasOwnProperty("onComplete")){var f=h-e*rowID-1;a.onComplete({row:a.row,frame:f})}});n()}else l.renderMeta.startRow!==a.row&&console.warn("Threesixty: loader row "+a.row+" is already loaded."),a.hasOwnProperty("onComplete")&&a.onComplete({row:a.row,frame:e-1})},c.prototype.renderer=function(){var a=this,c=a.renderMeta,d=c.normal,e=c.HD;c.currentRow=c.startRow,c.currentFrame=0,c.currentZoom=0,c.interactions={enabled:!1,isDragging:!1,startFrame:null,startRow:null,dragPosition:null,targetFrame:null,targetRow:null,startZoom:0,startDistance:0,zoom:1,initHD:!1},c.rotation={isPlaying:!1,frame:0},this.findFrame=function(b){if(b.row!==c.currentRow||b.frame!==c.currentFrame){c.currentRow=b.row,c.currentFrame=b.frame;var e=a.frames[b.row][b.frame],f=function(){a._context.clearRect(0,0,a._canvas.width,a._canvas.height),a._context.drawImage(e,0,0,d.width,d.height,0,0,a._canvas.width,a._canvas.height)};window.requestAnimationFrame?window.requestAnimationFrame(f):setTimeout(f,16)}},this.drawHDFrame=function(){var d=a.HDframes[c.currentRow][c.currentFrame];d!==b&&null!==d&&(a.lastHDimg=document.createElement("img"),a.lastHDimg.onload=function(){(e.width==b||0==e.width)&&(e.width=this.width),(e.height==b||0==e.height)&&(e.height=this.height),a._context.clearRect(0,0,a._canvas.width,a._canvas.height),a._context.drawImage(a.lastHDimg,0,0,e.width,e.height,0,0,a._canvas.width,a._canvas.height)},a.lastHDimg.src=d,0==c.interactions.initHD&&(c.interactions.initHD=!0))},this.swoosh=function(){c.rotation={frame:0,isPlaying:!1},$(c.rotation).animate({frame:c.perRow},{duration:1300,easing:"easeOutCubic",step:function(){a.findFrame({row:a.renderMeta.startRow,frame:Math.floor(this.frame)})},complete:function(){a.enableInteraction()}})},this.autoRotate=function(b){var d,b=b?b:1,e=c.rotationTime;if(0==c.rotation.isPlaying){if(c.rotation.isPlaying=!0,1==b){if(c.currentFrame==c.perRow-1)c.rotation.frame=0;else{c.rotation.frame=c.currentFrame;var f=c.perRow-c.currentFrame,g=f/c.perRow;e*=g}d=c.perRow}else if(-1==b){if(0==c.currentFrame)c.rotation.frame=c.perRow-1;else{c.rotation.frame=c.currentFrame;var g=c.currentFrame/c.perRow;e*=g}d=0}$(c.rotation).stop().animate({frame:d},{duration:e,easing:"linear",step:function(){c.rotation.isPlaying=!0;var b=Math.floor(c.rotation.frame);c.currentFrame!==b&&a.findFrame({row:c.currentRow,frame:b})},complete:function(){c.rotation.isPlaying=!1,a.autoRotate(b)}}),a.enableInteraction()}},this.stopAutoRotate=function(a){$(c.rotation).stop(),c.rotation.isPlaying=!1,a&&a()},this.animatedZoom=function(b){e.width/d.width;b.factor>1?b.factor=1:b.factor<=0&&(b.factor=0);var f=b.factor;b.duration||(b.duration=600),b.factor!==c.currentZoom&&$({factor:c.currentZoom}).animate({factor:f},{duration:b.duration,easing:"easeOutCubic",step:function(){a.applyZoom(this.factor)},complete:function(){b.callback&&b.callback()}})},this.applyZoom=function(b){var f=e.width/d.width;0!==c.extraZoom&&(f+=c.extraZoom);var b=b;0==c.interactions.initHD&&a.drawHDFrame(),c.rotation.hasOwnProperty("isPlaying")&&1==c.rotation.isPlaying&&a.stopAutoRotate(),0>b?b=0:b>1&&(b=1),c.currentZoom=b,a._$canvas.css("transform","matrix("+(1+(f-1)*b)+", 0, 0, "+(1+(f-1)*b)+", 0, 0)")},this.enableInteraction=function(){function b(a){var b={x:a[0].pageX,y:a[0].pageY},c={x:a[1].pageX,y:a[1].pageY};return d(b,c)}function d(a,b){var c=0,d=0;return c=b.x-a.x,c*=c,d=b.y-a.y,d*=d,Math.round(Math.sqrt(c+d))}function e(b){c.rotation.hasOwnProperty("isPlaying")&&1==c.rotation.isPlaying&&a.stopAutoRotate(),c.interactions.dragPosition=b,c.interactions.startFrame=c.currentFrame,c.interactions.startRow=c.currentRow,c.interactions.isDragging=!0,a.lastHDimg&&(a.lastHDimg.onload=null)}function f(b){var d=c.currentRow;if(2==a.ready&&a.frames.length>1){var e=-1*Math.round((b.y-c.interactions.dragPosition.y)/60);1==c.invertY&&(e*=-1),d=c.interactions.startRow+e;var f=d/a.frames.length;f=Math.floor(f>0?f:f),c.loopY?d+=-1*a.frames.length*f:0>f?d=0:f>0&&(d=a.frames.length-1)}var g=Math.round((b.x-c.interactions.dragPosition.x)/20);1==c.invertX&&(g*=-1);var h=c.interactions.startFrame+g,i=h/c.perRow;i=Math.floor(i>0?i:i),c.loopX?h+=-1*c.perRow*i:0>i?h=0:i>0&&(h=c.perRow-1),a.findFrame({row:d,frame:h})}function g(){1==c.interactions.isDragging&&(c.interactions.isDragging=!1,a.drawHDFrame())}0==c.interactions.enabled&&(c.interactions.enabled=!0,a.drawHDFrame(),a.$el.mousedown(function(a){e({x:a.pageX,y:a.pageY})}),$(window).mousemove(function(a){1==c.interactions.isDragging&&f({x:a.pageX,y:a.pageY})}),$(window).mouseup(g),a.$el.bind("touchstart",function(a){a.preventDefault();var d=a.originalEvent.touches;e({x:d[0].pageX,y:d[0].pageY}),d.length>1&&(c.interactions.startDistance=b(d),c.interactions.startZoom=c.currentZoom,$("#output").html("Startzoom: "+String(c.interactions.startZoom)))}),a.$el.bind("touchmove",function(d){d.preventDefault();var e=d.originalEvent.touches;if(1==c.interactions.isDragging&&1==e.length)f({x:e[0].pageX,y:e[0].pageY});else if(1==c.interactions.isDragging&&2==e.length){var g=b(e)-c.interactions.startDistance,h=0;h=c.interactions.startZoom+g/200,$("#output").html("diff: "+String(g)),h>=0&&1>=h&&a.applyZoom(h)}}),$(window).bind("touchend",function(a){a.preventDefault(),g(a)}),a.$el.bind("gesturestart",function(){}),a.$el.bind("gesturechange",function(){}),a.$el.on("mousewheel",function(b){b.preventDefault();var d=b.originalEvent.deltaY,e=Math.abs(d)/d;e&&a.applyZoom(c.currentZoom+e/50)}))},a.findFrame({row:a.renderMeta.startRow,frame:0})},c.VERSION="0.1.0",a.Threesixty=c}(this);
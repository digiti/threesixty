/*! threesixty 02-11-2014 */
!function(a,b){"use strict";var c=function(a){a=a||{};for(var b in this._defaults)a[b]=a[b]||this._defaults[b];var c=this;for(var d in this._defaults)typeof this._defaults[d]==typeof a[d]?c[d]=a[d]:console.warn("Threesixty: constructor option "+d+" must be of type "+typeof this._defaults[d]);this.$el||(this.$el=$(document.createElement("div")),this.$el.addClass("threesixty"),$("body").append(this.$el)),this.create(),this.layout()};c.prototype._defaults={$el:null,width:640,height:480,ready:0,renderMeta:{normal:{width:640,height:480},HD:{width:1280,height:960}}},c.prototype.create=function(){this.$el.html(""),this._canvas=document.createElement("canvas"),this._$canvas=$(this._canvas),this._$canvas.addClass("threesixty-canvas"),this.$el.append(this._$canvas),this._context=this._canvas.getContext("2d"),this._$loader=$(document.createElement("div")),this._$loader.addClass("threesixty-loader-bar"),this._$loader.width("0px"),this._$loader.height("3px"),this._$loader.css("background","#ff5c5c"),this._$loader.css("position","absolute"),this._$loader.css("top","0px"),this._$loader.css("left","0px"),this.$el.append(this._$loader),window.addEventListener("touchmove",function(a){a.target.classList.contains("threesixty-canvas")&&a.preventDefault()},!1)},c.prototype.layout=function(){this.$el.width(this.width),this.$el.height(this.height),this._$canvas.width(this.width),this._$canvas.height(this.height),this._$canvas.attr("width",this.renderMeta.HD.width),this._$canvas.attr("height",this.renderMeta.HD.height),this.$el.css("background","#000000"),this.$el.css("position","relative"),this.$el.css("overflow","hidden")},c.prototype.load=function(a){function b(){var a=0,b=function(){l.loadRow({row:a,render:!1,onFrame:function(a){var b=(a.frame+i*a.row)/(i*h),c=b*l.width;l._$loader.width(c)},onComplete:function(){h-1>a?(a++,b()):(l.ready=2,l._$loader.width(0),2==l.renderMeta.startOnStatus&&l.renderer())}})};b()}this.renderMeta={},a=a||{};var c={rows:1,loopX:!0,loopY:!1,speed:1,easing:.5,renderAfterLoad:!0,startOnStatus:1,startRow:-1,normal:{sources:[],width:640,height:480},HD:{sources:[],width:1280,height:960}};for(var d in c)a[d]=a[d]||c[d];var e=this;for(var f in c)typeof c[f]==typeof a[f]?e.renderMeta[f]=a[f]:console.warn("Threesixty: load option "+f+" must be of type "+typeof c[f]);this.renderMeta.renderAfterLoad&&this.layout(),this.frames=[];var g=this.renderMeta.normal.sources,h=this.renderMeta.rows,i=Math.floor(g.length/h);this.renderMeta.perRow=i;for(var j=0;j<this.renderMeta.rows;j++){this.frames.push([]);for(var k=i-1;k>=0;k--)this.frames[j].push(null)}-1==this.renderMeta.startRow&&(this.renderMeta.startRow=Math.floor(h/2));var l=this;this.loadRow({row:l.renderMeta.startRow,render:!0,onFrame:function(a){var b=a.frame/i,c=b*l.width;l._$loader.width(c)},onComplete:function(a){l._$loader.width(0),l.ready=1,h>1?(1==l.renderMeta.startOnStatus&&l.renderer(),b(a)):l.renderer()}})},c.prototype.loadRow=function(a){for(var c=this.renderMeta.normal.sources,d=this.renderMeta.rows,e=Math.floor(c.length/d),f=a.row*e,g=f+e-1,h=f,i=!1,j=e-1;j>=0;j--){var k=this.frames[a.row][j];null===k&&(i=!0)}var l=this;if(1==i){var m=l.renderMeta.normal,n=(l.renderMeta.HD,function(){var d=document.createElement("img");d.onload=function(){var c=a.row,d=h-e*c;if(null==l.frames[c][d]&&(l.frames[c][d]=this),h++,1==a.render&&(l._context.globalAlpha=1,l._context.clearRect(0,0,l.width,l.height),l._context.drawImage(this,0,0,m.width,m.height,0,0,l._canvas.width,l._canvas.height),g>=h&&(l._context.globalAlpha=.8,l._context.beginPath(),l._context.rect(0,0,l._canvas.width,l._canvas.height),l._context.fillStyle="#000000",l._context.fill())),h>g){if(a.hasOwnProperty("onComplete")){var d=h-e*c-1;a.onComplete({row:a.row,frame:d})}h=b}else{if(a.hasOwnProperty("onFrame")){var d=h-e*c-1;a.onFrame({row:a.row,frame:d})}n()}},d.src=c[h]});n()}else l.renderMeta.startRow!==a.row&&console.warn("Threesixty: loader row "+a.row+" is already loaded."),a.hasOwnProperty("onComplete")&&a.onComplete({row:a.row,frame:e-1})},c.prototype.renderer=function(){{var a=this,b=a.renderMeta,c=b.normal;b.HD}b.currentFrame=0,b.currentRow=0,b.interactions={isDragging:!1,startFrame:null,startRow:null,dragPosition:null,targetFrame:null,targetRow:null},this.findFrame=function(d,e){if(d!==b.currentRow||e!==b.currentFrame){b.currentRow=d,b.currentFrame=e;var f=a.frames[d][e];window.requestAnimationFrame(function(){a._context.clearRect(0,0,a._canvas.width,a._canvas.height),a._context.drawImage(f,0,0,c.width,c.height,0,0,a._canvas.width,a._canvas.height)})}};var d=function(){function c(a){b.interactions.dragPosition=a,b.interactions.startFrame=b.currentFrame,b.interactions.startRow=b.currentRow,b.interactions.isDragging=!0}function d(c){var d=b.currentRow;if(2==a.ready&&a.frames.length>1){var e=-1*Math.round((c.y-b.interactions.dragPosition.y)/60);d=b.interactions.startRow+e;var f=d/a.frames.length;f=Math.floor(f>0?f:f),d+=-1*a.frames.length*f}var g=Math.round((c.x-b.interactions.dragPosition.x)/30),h=b.interactions.startFrame+g,i=h/b.perRow;i=Math.floor(i>0?i:i),h+=-1*b.perRow*i,a.findFrame(d,h)}function e(){b.interactions.isDragging=!1}a.$el.mousedown(function(a){c({x:a.pageX,y:a.pageY})}),$(window).mousemove(function(a){1==b.interactions.isDragging&&d({x:a.pageX,y:a.pageY})}),$(window).mouseup(e),a.$el.bind("touchstart",function(a){a.preventDefault(),c({x:a.originalEvent.touches[0].pageX,y:a.originalEvent.touches[0].pageY})}),a.$el.bind("touchmove",function(a){a.preventDefault(),1==b.interactions.isDragging&&d({x:a.originalEvent.touches[0].pageX,y:a.originalEvent.touches[0].pageY})}),$(window).bind("touchend",function(a){a.preventDefault(),e(a)})};$({introFrame:0}).animate({introFrame:b.perRow},{duration:1500,easing:"easeOutCubic",step:function(){a.findFrame(a.renderMeta.startRow,Math.floor(this.introFrame))},complete:function(){d()}})},c.VERSION="0.1.0",a.Threesixty=c}(this);
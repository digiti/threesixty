/*! threesixty 07-11-2014 */
!function(){for(var a=0,b=["ms","moz","webkit","o"],c=0;c<b.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b){var c=(new Date).getTime(),d=Math.max(0,16-(c-a)),e=window.setTimeout(function(){b(c+d)},d);return a=c+d,e}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)})}(),function(a,b){"use strict";var c=function(a){a=a||{};for(var b in this._defaults)a[b]=a[b]||this._defaults[b];var c=this;for(var d in this._defaults)typeof this._defaults[d]==typeof a[d]?c[d]=a[d]:console.warn("Threesixty: constructor option "+d+" must be of type "+typeof this._defaults[d]);this.$el||(this.$el=$(document.createElement("div")),this.$el.addClass("threesixty"),$("body").append(this.$el)),this.create(),this.layout()};c.prototype._defaults={$el:null,width:640,height:480,ready:0,renderMeta:{normal:{width:640,height:480},HD:{width:1280,height:960}}},c.prototype.create=function(){this.$el.html(""),this._canvas=document.createElement("canvas"),this._$canvas=$(this._canvas),this._$canvas.addClass("threesixty-canvas"),this.$el.append(this._$canvas),this._context=this._canvas.getContext("2d"),this._$loader=$(document.createElement("div")),this._$loader.addClass("threesixty-loader-bar"),this._$loader.width("0px"),this._$loader.height("3px"),this._$loader.css("background","#ff5c5c"),this._$loader.css("position","absolute"),this._$loader.css("top","0px"),this._$loader.css("left","0px"),this.$el.append(this._$loader),window.addEventListener("touchmove",function(a){a.target.classList.contains("threesixty-canvas")&&a.preventDefault()},!1)},c.prototype.layout=function(){this.$el.width(this.width),this.$el.height(this.height),this._$canvas.width(this.width),this._$canvas.height(this.height),this._$canvas.attr("width",this.renderMeta.HD.width),this._$canvas.attr("height",this.renderMeta.HD.height),this.$el.css("background","#000000"),this.$el.css("position","relative"),this.$el.css("overflow","hidden")},c.prototype.load=function(a){function b(){var a=0,b=function(){o.loadRow({row:a,render:!1,onFrame:function(a){var b=(a.frame+k*a.row)/(k*j),c=b*o.width;o._$loader.width(c)},onComplete:function(){j-1>a?(a++,b()):(o.ready=2,o._$loader.width(0),2==o.renderMeta.startOnStatus&&o.renderer())}})};b()}this.renderMeta={},a=a||{};var c={rows:1,loopX:!0,loopY:!1,speed:1,easing:.5,renderAfterLoad:!0,startOnStatus:1,startRow:-1,normal:{sources:[],width:640,height:480},HD:{sources:[],width:1280,height:960}};for(var d in c)a[d]=a.hasOwnProperty(d)?a[d]:c[d];var e=this;for(var f in c)typeof c[f]==typeof a[f]?e.renderMeta[f]=a[f]:console.warn("Threesixty: load option "+f+" must be of type "+typeof c[f]);this.renderMeta.renderAfterLoad&&this.layout(),this.frames=[],this.HDframes=[];var g=this.renderMeta.normal.sources,h=this.renderMeta.HD.sources,i=!1;h&&h.length>0&&g.length==h.length&&(i=!0);var j=this.renderMeta.rows,k=Math.floor(g.length/j);this.renderMeta.perRow=k;for(var l=0;l<this.renderMeta.rows;l++){this.frames.push([]),this.HDframes.push([]);for(var m=k-1;m>=0;m--)if(this.frames[l].push(null),i===!0){var n=h[k-m-1+k*l];this.HDframes[l].push(n)}}-1==this.renderMeta.startRow&&(this.renderMeta.startRow=Math.floor(j/2));var o=this;this.loadRow({row:o.renderMeta.startRow,render:!0,onFrame:function(a){var b=a.frame/k,c=b*o.width;o._$loader.width(c)},onComplete:function(a){o._$loader.width(0),o.ready=1,j>1?(1==o.renderMeta.startOnStatus&&o.renderer(),b(a)):o.renderer()}})},c.prototype.loadRow=function(a){for(var c=this.renderMeta.normal.sources,d=this.renderMeta.rows,e=Math.floor(c.length/d),f=a.row*e,g=f+e-1,h=f,i=!1,j=e-1;j>=0;j--){var k=this.frames[a.row][j];null===k&&(i=!0)}var l=this;if(1==i){var m=l.renderMeta.normal,n=(l.renderMeta.HD,function(){var d=document.createElement("img");d.onload=function(){var c=a.row,d=h-e*c;if(null==l.frames[c][d]&&(l.frames[c][d]=this),h++,1==a.render&&(l._context.globalAlpha=1,l._context.clearRect(0,0,l.width,l.height),l._context.drawImage(this,0,0,m.width,m.height,0,0,l._canvas.width,l._canvas.height),g>=h&&(l._context.globalAlpha=.8,l._context.beginPath(),l._context.rect(0,0,l._canvas.width,l._canvas.height),l._context.fillStyle="#000000",l._context.fill())),h>g){if(a.hasOwnProperty("onComplete")){var d=h-e*c-1;a.onComplete({row:a.row,frame:d})}h=b}else{if(a.hasOwnProperty("onFrame")){var d=h-e*c-1;a.onFrame({row:a.row,frame:d})}n()}},d.src=c[h]});n()}else l.renderMeta.startRow!==a.row&&console.warn("Threesixty: loader row "+a.row+" is already loaded."),a.hasOwnProperty("onComplete")&&a.onComplete({row:a.row,frame:e-1})},c.prototype.renderer=function(){var a=this,c=a.renderMeta,d=c.normal,e=c.HD;c.currentFrame=0,c.currentRow=0,c.currentZoom=1,c.interactions={isDragging:!1,startFrame:null,startRow:null,dragPosition:null,targetFrame:null,targetRow:null,startZoom:1},this.findFrame=function(b){if(b.row!==c.currentRow||b.frame!==c.currentFrame){c.currentRow=b.row,c.currentFrame=b.frame;var e=a.frames[b.row][b.frame],f=function(){a._context.clearRect(0,0,a._canvas.width,a._canvas.height),a._context.drawImage(e,0,0,d.width,d.height,0,0,a._canvas.width,a._canvas.height)};window.requestAnimationFrame?window.requestAnimationFrame(f):setTimeout(f,16)}},this.drawHDFrame=function(){var d=a.HDframes[c.currentRow][c.currentFrame];d!==b&&null!==d&&(a.lastHDimg=document.createElement("img"),a.lastHDimg.onload=function(){a._context.clearRect(0,0,a._canvas.width,a._canvas.height),a._context.drawImage(a.lastHDimg,0,0,e.width,e.height,0,0,a._canvas.width,a._canvas.height)},a.lastHDimg.src=d)};var f=function(){function b(b){c.currentZoom=b;var f=e.width/d.width;1>b?c.currentZoom=1:b>f&&(c.currentZoom=f),a._$canvas.css("transform","matrix("+c.currentZoom+", 0, 0, "+c.currentZoom+", 0, 0)")}function f(b){c.interactions.dragPosition=b,c.interactions.startFrame=c.currentFrame,c.interactions.startRow=c.currentRow,c.interactions.isDragging=!0,a.lastHDimg&&(a.lastHDimg.onload=null)}function g(b){var d=c.currentRow;if(2==a.ready&&a.frames.length>1){var e=-1*Math.round((b.y-c.interactions.dragPosition.y)/60);d=c.interactions.startRow+e;var f=d/a.frames.length;f=Math.floor(f>0?f:f),c.loopY?d+=-1*a.frames.length*f:0>f?d=0:f>0&&(d=a.frames.length-1)}var g=Math.round((b.x-c.interactions.dragPosition.x)/20),h=c.interactions.startFrame+g,i=h/c.perRow;i=Math.floor(i>0?i:i),c.loopX?h+=-1*c.perRow*i:0>i?h=0:i>0&&(h=c.perRow-1),a.findFrame({row:d,frame:h})}function h(){1==c.interactions.isDragging&&(c.interactions.isDragging=!1,a.drawHDFrame())}a.$el.mousedown(function(a){f({x:a.pageX,y:a.pageY})}),$(window).mousemove(function(a){1==c.interactions.isDragging&&g({x:a.pageX,y:a.pageY})}),$(window).mouseup(h),a.$el.bind("touchstart",function(a){a.preventDefault(),f({x:a.originalEvent.touches[0].pageX,y:a.originalEvent.touches[0].pageY})}),a.$el.bind("touchmove",function(a){a.preventDefault();var b=a.originalEvent.touches;1==c.interactions.isDragging&&b.length<=1&&g({x:b[0].pageX,y:b[0].pageY})}),$(window).bind("touchend",function(a){a.preventDefault(),h(a)}),a.$el.bind("gesturestart",function(a){a.preventDefault(),c.interactions.startZoom=c.currentZoom}),a.$el.bind("gesturechange",function(a){a.preventDefault();var d=c.interactions.startZoom+(-1+a.originalEvent.scale)*c.interactions.startZoom;d&&b(d)}),a.$el.on("mousewheel",function(a){a.preventDefault();var d=a.originalEvent.deltaY,e=Math.abs(d)/d;e&&b(c.currentZoom+e/50)})};$({introFrame:0}).animate({introFrame:c.perRow},{duration:1500,easing:"easeOutCubic",step:function(){a.findFrame({row:a.renderMeta.startRow,frame:Math.floor(this.introFrame)})},complete:function(){f()}})},c.VERSION="0.1.0",a.Threesixty=c}(this);